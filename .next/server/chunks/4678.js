exports.id=4678,exports.ids=[4678],exports.modules={9078:(e,t,a)=>{"use strict";a.d(t,{ND:()=>n,zD:()=>i});let n={trial:{id:"plan_trial_7",name:"Trial 7 Days",type:"trial",description:"Essai gratuit pendant 7 jours",price:0,currency:"EUR",features:{maxUsers:5,maxProducts:100,storageLimit:1024,enablePayments:!1,supportLevel:"basic"},isActive:!0},monthly:{id:"plan_monthly",name:"Professional Monthly",type:"monthly",description:"Plan mensuel professionnel",price:49.99,currency:"EUR",billingCycle:"monthly",features:{maxUsers:25,maxProducts:5e3,storageLimit:10240,enablePayments:!0,supportLevel:"standard"},isActive:!0},quarterly:{id:"plan_quarterly",name:"Enterprise Quarterly",type:"quarterly",description:"Plan trimestriel entreprise",price:129.99,currency:"EUR",billingCycle:"quarterly",features:{maxUsers:50,maxProducts:1e4,storageLimit:51200,enablePayments:!0,supportLevel:"premium"},isActive:!0},annual:{id:"plan_annual",name:"Enterprise Annual",type:"annual",description:"Plan annuel entreprise",price:449.99,currency:"EUR",billingCycle:"annual",features:{maxUsers:100,maxProducts:5e4,storageLimit:102400,enablePayments:!0,supportLevel:"premium"},isActive:!0},lifetime:{id:"plan_lifetime",name:"Lifetime License",type:"lifetime",description:"Licence \xe0 vie permanente",price:999.99,currency:"EUR",features:{maxUsers:500,maxProducts:999999,storageLimit:1048576,enablePayments:!0,supportLevel:"premium"},isActive:!0}},i={PROJECT_PREFIX:"pharma-",ENVIRONMENT_VARIABLES:{APP_NAME:"APP_NAME",APP_COLOR_PRIMARY:"PRIMARY_COLOR",APP_COLOR_SECONDARY:"SECONDARY_COLOR",APP_LOGO_URL:"LOGO_URL",DATABASE_URL:"DATABASE_URL",API_KEY:"API_KEY",PLAN_TYPE:"PLAN_TYPE",TRIAL_EXPIRE_AT:"TRIAL_EXPIRE_AT",SUBSCRIPTION_STATUS:"SUBSCRIPTION_STATUS"}}},41863:(e,t,a)=>{"use strict";a.d(t,{n:()=>r});var n=a(79464),i=a(9078);class r{async createSubscription(e){let t=i.ND[e.planType];if(!t)throw Error(`Plan type "${e.planType}" not found`);let a=new Date,n=null,r=0;if("trial"===e.planType){let t=e.planDuration||7;r=t,(n=new Date(a)).setDate(n.getDate()+t)}else"monthly"===e.planType?(n=new Date(a)).setMonth(n.getMonth()+1):"quarterly"===e.planType?(n=new Date(a)).setMonth(n.getMonth()+3):"annual"===e.planType&&(n=new Date(a)).setFullYear(n.getFullYear()+1);return{id:this.generateSubscriptionId(),instanceId:"",planType:e.planType,planName:t.name,startDate:a,endDate:n||void 0,trialDaysRemaining:r,amount:t.price,currency:t.currency,billingCycle:t.billingCycle,autoRenew:"trial"!==e.planType,status:"active",failedPaymentAttempts:0,createdAt:a,updatedAt:a}}async saveSubscription(e,t,a){let r=i.ND[t];if(!r)throw Error(`Plan type "${t}" not found`);let s=new Date,o=null,l=0;if("trial"===t){let e=a?.planDuration||7;l=e,(o=new Date(s)).setDate(o.getDate()+e)}else"monthly"===t?(o=new Date(s)).setMonth(o.getMonth()+1):"quarterly"===t?(o=new Date(s)).setMonth(o.getMonth()+3):"annual"===t&&(o=new Date(s)).setFullYear(o.getFullYear()+1);return await n.z.subscription.create({data:{instanceId:e,planType:t,planName:r.name,startDate:s,endDate:o||null,trialDaysRemaining:l,amount:r.price,currency:r.currency,billingCycle:r.billingCycle||null,autoRenew:a?.autoRenew??"trial"!==t,status:"active",paymentMethod:a?.paymentMethod,failedPaymentAttempts:0}})}async getSubscription(e){return n.z.subscription.findUnique({where:{id:e}})}async getInstanceSubscription(e){return n.z.subscription.findUnique({where:{instanceId:e}})}async renewSubscription(e){let t=await this.getSubscription(e);if(!t)throw Error("Subscription not found");i.ND[t.planType];let a=new Date,r=null;return"monthly"===t.planType?(r=new Date(a)).setMonth(r.getMonth()+1):"quarterly"===t.planType?(r=new Date(a)).setMonth(r.getMonth()+3):"annual"===t.planType&&(r=new Date(a)).setFullYear(r.getFullYear()+1),await n.z.subscription.update({where:{id:e},data:{startDate:a,endDate:r||null,status:"active",failedPaymentAttempts:0,nextBillingDate:r||null}})}async cancelSubscription(e){return await n.z.subscription.update({where:{id:e},data:{status:"cancelled",endDate:new Date}})}async suspendSubscription(e,t){return await n.z.subscription.update({where:{id:e},data:{status:"suspended"}})}async expireSubscription(e){return await n.z.subscription.update({where:{id:e},data:{status:"expired",endDate:new Date}})}async recordPaymentFailure(e){let t=await this.getSubscription(e);if(!t)throw Error("Subscription not found");let a=t.failedPaymentAttempts+1;return a>=3?await this.suspendSubscription(e,`Payment failed ${a} times`):await n.z.subscription.update({where:{id:e},data:{failedPaymentAttempts:a,status:a>=2?"pending_payment":"active"}})}async getExpiredSubscriptions(){let e=new Date;return n.z.subscription.findMany({where:{endDate:{lte:e},status:"active"}})}async getExpiringSubscriptions(e=2){let t=new Date,a=new Date(t);return a.setDate(a.getDate()+e),n.z.subscription.findMany({where:{endDate:{lte:a,gt:t},status:"active",expireReminderSentAt:null}})}async markExpirationReminderSent(e){await n.z.subscription.update({where:{id:e},data:{expireReminderSentAt:new Date}})}generateSubscriptionId(){return`sub_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}new r},45178:(e,t,a)=>{"use strict";a.d(t,{b:()=>o});var n=a(79464),i=a(9078);class r{constructor(){this.apiUrl="https://api.vercel.com",this.apiToken=process.env.VERCEL_API_TOKEN||"",this.teamId=process.env.VERCEL_TEAM_ID||"",this.apiToken||console.warn("VERCEL_API_TOKEN not set")}async deployInstance(e){let t=`${i.zD.PROJECT_PREFIX}${e.subdomain}`,a=await this.createOrGetProject(t),n=await this.createEnvironment(a.id),r=await this.configureEnvironmentVariables(a.id,n.id,e),s=await this.triggerDeployment(a.id,e.subdomain,r);return{projectId:a.id,projectName:a.name,environmentId:n.id,deploymentUrl:s.url,variables:r}}async createOrGetProject(e){try{let t=await fetch(`${this.apiUrl}/v9/projects/${e}?teamId=${this.teamId}`,{headers:{Authorization:`Bearer ${this.apiToken}`}});if(t.ok)return t.json();if(404===t.status){let t=await fetch(`${this.apiUrl}/v10/projects`,{method:"POST",headers:{Authorization:`Bearer ${this.apiToken}`,"Content-Type":"application/json"},body:JSON.stringify({name:e,teamId:this.teamId,framework:"nextjs",buildCommand:"npm run build",installCommand:"npm install",outputDirectory:".next"})});if(!t.ok)throw Error(`Failed to create project: ${t.statusText}`);return t.json()}throw Error(`Failed to get project: ${t.statusText}`)}catch(e){throw console.error("Error in createOrGetProject:",e),e}}async createEnvironment(e){return{id:"default",name:"Production"}}async configureEnvironmentVariables(e,t,a){let n=[{key:i.zD.ENVIRONMENT_VARIABLES.APP_NAME,value:a.name,type:"plain"},{key:i.zD.ENVIRONMENT_VARIABLES.APP_COLOR_PRIMARY,value:a.primaryColor,type:"plain"},{key:i.zD.ENVIRONMENT_VARIABLES.APP_COLOR_SECONDARY,value:a.secondaryColor,type:"plain"},{key:i.zD.ENVIRONMENT_VARIABLES.APP_LOGO_URL,value:a.logo||"",type:"plain"},{key:i.zD.ENVIRONMENT_VARIABLES.API_KEY,value:a.apiKey,type:"secret"},{key:i.zD.ENVIRONMENT_VARIABLES.PLAN_TYPE,value:"trial",type:"plain"},{key:i.zD.ENVIRONMENT_VARIABLES.SUBSCRIPTION_STATUS,value:"active",type:"plain"}],r={};for(let t of n)try{await fetch(`${this.apiUrl}/v10/projects/${e}/env?teamId=${this.teamId}`,{method:"POST",headers:{Authorization:`Bearer ${this.apiToken}`,"Content-Type":"application/json"},body:JSON.stringify({key:t.key,value:t.value,type:t.type,target:["production","preview","development"]})}),r[t.key]=t.value}catch(e){console.error(`Failed to set environment variable ${t.key}:`,e)}return r}async updateEnvironmentVariables(e,t,a){for(let[t,n]of Object.entries(a))try{let a=await fetch(`${this.apiUrl}/v9/projects/${e}/env?key=${t}&teamId=${this.teamId}`,{headers:{Authorization:`Bearer ${this.apiToken}`}});if(a.ok){let t=await a.json();await fetch(`${this.apiUrl}/v9/projects/${e}/env/${t.id}?teamId=${this.teamId}`,{method:"PATCH",headers:{Authorization:`Bearer ${this.apiToken}`,"Content-Type":"application/json"},body:JSON.stringify({value:n})})}else await fetch(`${this.apiUrl}/v10/projects/${e}/env?teamId=${this.teamId}`,{method:"POST",headers:{Authorization:`Bearer ${this.apiToken}`,"Content-Type":"application/json"},body:JSON.stringify({key:t,value:n,type:"plain",target:["production","preview","development"]})})}catch(e){console.error(`Failed to update environment variable ${t}:`,e)}}async triggerDeployment(e,t,a){let n=await fetch(`${this.apiUrl}/v13/deployments?teamId=${this.teamId}`,{method:"POST",headers:{Authorization:`Bearer ${this.apiToken}`,"Content-Type":"application/json"},body:JSON.stringify({name:t,project:e,gitSource:{type:"github",repo:process.env.GITHUB_REPO||"simon571/AfrikacashPharma",ref:"main"}})});if(!n.ok)throw Error(`Failed to trigger deployment: ${n.statusText}`);let i=await n.json();return{id:i.id,url:i.url,status:i.status}}async deleteProject(e){try{let t=await fetch(`${this.apiUrl}/v9/projects/${e}?teamId=${this.teamId}`,{method:"DELETE",headers:{Authorization:`Bearer ${this.apiToken}`}});if(!t.ok)throw Error(`Failed to delete project: ${t.statusText}`)}catch(e){throw console.error("Error deleting project:",e),e}}async getDeploymentStatus(e,t){try{let e=await fetch(`${this.apiUrl}/v11/deployments/${t}?teamId=${this.teamId}`,{headers:{Authorization:`Bearer ${this.apiToken}`}});if(!e.ok)throw Error(`Failed to get deployment status: ${e.statusText}`);return e.json()}catch(e){throw console.error("Error getting deployment status:",e),e}}async configureDomain(e,t){try{let a=await fetch(`${this.apiUrl}/v10/projects/${e}/domains?teamId=${this.teamId}`,{method:"POST",headers:{Authorization:`Bearer ${this.apiToken}`,"Content-Type":"application/json"},body:JSON.stringify({domain:t})});if(!a.ok)throw Error(`Failed to configure domain: ${a.statusText}`)}catch(e){throw console.error("Error configuring domain:",e),e}}}new r;var s=a(41863);class o{constructor(){this.vercelService=new r,this.subscriptionService=new s.n}async createInstance(e){if(await n.z.instance.findUnique({where:{subdomain:e.subdomain}}))throw Error(`Le subdomain "${e.subdomain}" est d\xe9j\xe0 utilis\xe9`);let t=await this.subscriptionService.createSubscription({planType:e.planType,planDuration:e.planDuration}),a=await this.vercelService.deployInstance({name:e.name,subdomain:e.subdomain,primaryColor:e.primaryColor||"#3B82F6",secondaryColor:e.secondaryColor||"#10B981",logo:e.logo,apiKey:this.generateApiKey()}),i=await n.z.instance.create({data:{name:e.name,subdomain:e.subdomain,ownerName:e.ownerName,ownerEmail:e.ownerEmail,ownerPhone:e.ownerPhone,logo:e.logo,primaryColor:e.primaryColor||"#3B82F6",secondaryColor:e.secondaryColor||"#10B981",subscriptionId:t.id,vercelProjectId:a.projectId,vercelDeploymentUrl:a.deploymentUrl,vercelEnvironmentId:a.environmentId,apiKey:a.variables.API_KEY,databaseUrl:a.variables.DATABASE_URL,status:"pending",settings:{create:{appName:e.name,paymentProviders:["avadapay","strowallet"]}}},include:{subscription:!0,settings:!0}});return await this.logAudit(i.id,"create",{vercelProjectId:a.projectId,subscriptionId:t.id}),i}async updateInstance(e,t){let a=await n.z.instance.findUnique({where:{id:e}});if(!a)throw Error("Instance not found");if(t.customDomain&&t.customDomain!==a.customDomain&&!await this.verifyCustomDomain(t.customDomain))throw Error("Impossible de v\xe9rifier le domaine");let i=await n.z.instance.update({where:{id:e},data:{name:t.name,status:t.status,logo:t.logo,primaryColor:t.primaryColor,secondaryColor:t.secondaryColor,customDomain:t.customDomain,domainVerified:!!t.customDomain||a.domainVerified},include:{subscription:!0,settings:!0}});return a.vercelProjectId&&a.vercelEnvironmentId&&await this.vercelService.updateEnvironmentVariables(a.vercelProjectId,a.vercelEnvironmentId,{APP_NAME:t.name||a.name,PRIMARY_COLOR:t.primaryColor||a.primaryColor,SECONDARY_COLOR:t.secondaryColor||a.secondaryColor,LOGO_URL:t.logo||a.logo||""}),await this.logAudit(e,"update",t),i}async getInstance(e){return await n.z.instance.findUnique({where:{id:e},include:{subscription:!0,settings:!0}})}async getInstanceBySubdomain(e){return await n.z.instance.findUnique({where:{subdomain:e},include:{subscription:!0,settings:!0}})}async listInstances(e){let t={};e?.status&&(t.status=e.status),e?.planType&&(t.subscription={planType:e.planType});let[a,i]=await Promise.all([n.z.instance.findMany({where:t,include:{subscription:!0,settings:!0},take:e?.limit||50,skip:e?.offset||0,orderBy:{createdAt:"desc"}}),n.z.instance.count({where:t})]);return{instances:a,total:i}}async suspendInstance(e,t){let a=await n.z.instance.update({where:{id:e},data:{status:"suspended"},include:{subscription:!0,settings:!0}});return await this.logAudit(e,"suspend",{reason:t}),a}async reactivateInstance(e){let t=await n.z.instance.update({where:{id:e},data:{status:"active"},include:{subscription:!0,settings:!0}});return await this.logAudit(e,"reactivate",{}),t}async deleteInstance(e){let t=await n.z.instance.findUnique({where:{id:e}});if(!t)throw Error("Instance not found");t.vercelProjectId&&await this.vercelService.deleteProject(t.vercelProjectId),await this.subscriptionService.cancelSubscription(t.subscriptionId),await n.z.instance.delete({where:{id:e}}),await this.logAudit(e,"delete",{})}async updateInstanceStats(e,t){await n.z.instance.update({where:{id:e},data:{activeUsers:t.activeUsers,totalOrders:t.totalOrders,monthlyRevenue:t.monthlyRevenue,lastActivityAt:new Date}})}generateApiKey(){let e=Date.now().toString(36),t=Math.random().toString(36).substring(2,15);return`${e}-${t}`}async verifyCustomDomain(e){return!0}async logAudit(e,t,a){await n.z.instanceAuditLog.create({data:{instanceId:e,action:t,userId:"super-admin",changes:a||{}}})}}new o},78335:()=>{},79464:(e,t,a)=>{"use strict";a.d(t,{z:()=>i});var n=a(96330);let i=global.__prismaClient__??new n.PrismaClient},96487:()=>{}};