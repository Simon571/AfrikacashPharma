(()=>{var e={};e.id=4290,e.ids=[4290],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11723:e=>{"use strict";e.exports=require("querystring")},12269:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},12412:e=>{"use strict";e.exports=require("assert")},12909:(e,t,r)=>{"use strict";r.d(t,{N:()=>s});var n=r(13581),a=r(31183),o=r(85663);let s={providers:[(0,n.A)({name:"Credentials",credentials:{username:{label:"Username",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){if(console.log("[auth] Tentative de connexion",e?.username??"(aucun)"),!e?.username||!e.password)return console.warn("[auth] Identifiants incomplets"),null;try{let t=await a.z.user.findUnique({where:{username:e.username}});if(!t)return console.warn("[auth] Utilisateur introuvable",e.username),null;let r=await o.Ay.compare(e.password,t.passwordHash);if(console.log("[auth] V\xe9rification mot de passe",r?"OK":"ECHEC"),!r)return null;return{id:t.id,name:t.username,role:t.role}}catch(r){console.error("[auth] Erreur:",r);let t=[{id:"admin-1",username:"admin",password:"Admin123!",role:"admin"},{id:"seller-1",username:"vendeur",password:"vendeur123",role:"seller"},{id:"superadmin-1",username:"superadmin",password:"SuperAdmin123!",role:"admin"}].find(t=>t.username===e.username);if(t&&t.password===e.password)return console.log("[auth] Authentification avec utilisateur par d\xe9faut"),{id:t.id,name:t.username,role:t.role};return null}}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.role=t.role),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id,e.user.role=t.role),e)},pages:{signIn:"/",error:"/auth/error",signOut:"/"}}},13581:(e,t)=>{"use strict";t.A=function(e){return{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:e}}},19854:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n={};Object.defineProperty(t,"default",{enumerable:!0,get:function(){return o.default}});var a=r(12269);Object.keys(a).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))});var o=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=s(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&({}).hasOwnProperty.call(e,o)){var i=a?Object.getOwnPropertyDescriptor(e,o):null;i&&(i.get||i.set)?Object.defineProperty(n,o,i):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}(r(35426));function s(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(s=function(e){return e?r:t})(e)}Object.keys(o).forEach(function(e){!("default"===e||"__esModule"===e||Object.prototype.hasOwnProperty.call(n,e))&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))})},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},31183:(e,t,r)=>{"use strict";r.d(t,{z:()=>a});var n=r(96330);let a=global.prisma||new n.PrismaClient},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},56353:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>w,routeModule:()=>f,serverHooks:()=>g,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{GET:()=>m,dynamic:()=>d,revalidate:()=>p});var a=r(96559),o=r(48088),s=r(37719),i=r(32190),u=r(19854),l=r(12909);let{PrismaClient:c}=r(96330),d="force-dynamic",p=0;async function m(e){let t=new c;try{let e=await (0,u.getServerSession)(l.N);if(!e?.user)return i.NextResponse.json({error:"Non autoris\xe9"},{status:401});if("admin"!==e.user.role)return i.NextResponse.json({error:"Acc\xe8s refus\xe9"},{status:403});let r=new Date,n=new Date(r.getFullYear(),r.getMonth(),r.getDate()),a=new Date(r.getFullYear(),r.getMonth(),r.getDate(),23,59,59),o=await t.user.findMany({where:{role:"seller"},select:{id:!0,username:!0}}),s=await t.sale.findMany({where:{date:{gte:n,lte:a}},include:{items:{include:{medication:!0}},client:!0,seller:!0}}),c=await t.expense.findMany({where:{date:{gte:n,lte:a}},include:{user:!0}}),d=s.reduce((e,t)=>e+t.totalAmount,0),p=c.reduce((e,t)=>e+t.amount,0),m=new Set(s.map(e=>e.sellerId)).size,f=o.map(e=>{let t=s.filter(t=>t.sellerId===e.id),r=c.filter(t=>t.userId===e.id),n=t.reduce((e,t)=>e+t.totalAmount,0),a=r.reduce((e,t)=>e+t.amount,0),o={};t.forEach(e=>{e.items.forEach(e=>{let t=e.medicationId;o[t]||(o[t]={name:e.medication.name,quantity:0,revenue:0}),o[t].quantity+=e.quantity,o[t].revenue+=e.priceAtSale*e.quantity})});let i=Object.values(o).sort((e,t)=>t.quantity-e.quantity).slice(0,3);return{sellerId:e.id,sellerName:e.username,totalSales:n,salesCount:t.length,totalExpenses:a,expensesCount:r.length,netResult:n-a,topMedications:i,salesDetails:t.map(e=>({id:e.id,date:e.date.toISOString(),totalAmount:e.totalAmount,paymentMethod:e.paymentMethod,client:{name:e.client.name},itemsCount:e.items.length})),expensesDetails:r.map(e=>({id:e.id,description:e.description,amount:e.amount,date:e.date.toISOString()}))}}),y={};s.forEach(e=>{e.items.forEach(e=>{let t=e.medicationId;y[t]||(y[t]={name:e.medication.name,totalQuantity:0,totalRevenue:0}),y[t].totalQuantity+=e.quantity,y[t].totalRevenue+=e.priceAtSale*e.quantity})});let h=Object.values(y).sort((e,t)=>t.totalQuantity-e.totalQuantity).slice(0,5),g={};s.forEach(e=>{g[e.paymentMethod]||(g[e.paymentMethod]={count:0,amount:0}),g[e.paymentMethod].count+=1,g[e.paymentMethod].amount+=e.totalAmount});let w=Object.entries(g).map(([e,t])=>({method:e,count:t.count,amount:t.amount,percentage:d>0?t.amount/d*100:0})),v={overallStats:{totalSales:d,totalExpenses:p,netResult:d-p,activeSellers:m,totalTransactions:s.length},sellerReports:f,topSellingMedications:h,paymentMethodsBreakdown:w};return new i.NextResponse(JSON.stringify(v),{headers:{"Content-Type":"application/json","Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate",Pragma:"no-cache",Expires:"0","Surrogate-Control":"no-store"}})}catch(e){return console.error("Erreur lors de la g\xe9n\xe9ration du rapport global:",e),i.NextResponse.json({error:"Erreur lors de la g\xe9n\xe9ration du rapport global"},{status:500,headers:{"Cache-Control":"no-store"}})}finally{await t.$disconnect()}}let f=new a.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/admin/global-report/route",pathname:"/api/admin/global-report",filename:"route",bundlePath:"app/api/admin/global-report/route"},resolvedPagePath:"C:\\Users\\Public\\Documents\\Console Afrikapharma\\AfrikaPharma\\src\\app\\api\\admin\\global-report\\route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:y,workUnitAsyncStorage:h,serverHooks:g}=f;function w(){return(0,s.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:h})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},76926:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"createDedupedByCallsiteServerErrorLoggerDev",{enumerable:!0,get:function(){return u}});let n=function(e,t){if(e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=a(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if("default"!==s&&Object.prototype.hasOwnProperty.call(e,s)){var i=o?Object.getOwnPropertyDescriptor(e,s):null;i&&(i.get||i.set)?Object.defineProperty(n,s,i):n[s]=e[s]}return n.default=e,r&&r.set(e,n),n}(r(61120));function a(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(a=function(e){return e?r:t})(e)}let o={current:null},s="function"==typeof n.cache?n.cache:e=>e,i=console.warn;function u(e){return function(...t){i(e(...t))}}s(e=>{try{i(o.current)}finally{o.current=null}})},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},94735:e=>{"use strict";e.exports=require("events")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[4243,580,5663,5426],()=>r(56353));module.exports=n})();