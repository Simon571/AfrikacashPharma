(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2715],{2218:(e,s,t)=>{Promise.resolve().then(t.bind(t,4665))},4665:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>k});var a=t(5155),r=t(2115),n=t(2523),i=t(285),c=t(5127),l=t(6695),o=t(6671),d=t(7901),m=t(1154),x=t(9103),u=t(7809),h=t(2525),p=t(8309),j=t(1304),f=t(2897),N=t(8855),v=t(6609),g=t(9434),y=t(4165),b=t(4790),w=t(5057),C=t(9368),A=t(162);function k(){let[e,s]=(0,r.useState)(""),[t,k]=(0,r.useState)([]),[R,q]=(0,r.useState)([]),[S,E]=(0,r.useState)(""),[P,I]=(0,r.useState)("name"),[z,$]=(0,r.useState)(!1),[F,L]=(0,r.useState)(!1),[O,T]=(0,r.useState)(!1),D=r.useRef(null),[_,M]=(0,r.useState)(!1),[H,Z]=(0,r.useState)(!1),B=(0,f.d)(e,300);(0,r.useEffect)(()=>{e!==B?T(!0):T(!1)},[e,B]);let J=(0,r.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";L(!0);try{let s=await (0,N.Pz)({search:e.trim()});Array.isArray(s)?k(s):(console.error("Invalid data format received:",s),k([]))}catch(e){console.error("Error loading medications:",e),o.oR.error("Erreur lors du chargement des m\xe9dicaments"),k([])}finally{L(!1)}},[]);(0,r.useEffect)(()=>{J(B)},[B,J]);let V=(0,r.useCallback)(e=>{if(e.quantity<=0)return void o.oR.error("Ce m\xe9dicament est en rupture de stock");q(s=>{let t=s.find(s=>s.medication.id===e.id);if(!t)return o.oR.success("".concat(e.name," ajout\xe9 au panier")),[...s,{medication:e,quantity:1}];{if(t.quantity>=e.quantity)return o.oR.error("Stock insuffisant"),s;let a=s.map(s=>s.medication.id===e.id?{...s,quantity:s.quantity+1}:s);return o.oR.success("".concat(e.name," ajout\xe9 au panier")),a}})},[]),W=(0,r.useCallback)((e,s)=>{q(t=>s<=0?t.filter(s=>s.medication.id!==e):t.map(t=>t.medication.id===e?s>t.medication.quantity?(o.oR.error("Stock insuffisant"),t):{...t,quantity:s}:t))},[]),G=(0,r.useCallback)(e=>{q(s=>s.filter(s=>s.medication.id!==e)),o.oR.success("Article retir\xe9 du panier")},[]),Q=(0,r.useCallback)(()=>{q([]),o.oR.success("Panier vid\xe9")},[]),U=R.reduce((e,s)=>e+s.medication.price*s.quantity,0),X=(0,v.useReactToPrint)({contentRef:D,documentTitle:"Facture-".concat(new Date().toISOString().split("T")[0]),onAfterPrint:()=>{Z(!1),o.oR.success("Facture imprim\xe9e/enregistr\xe9e avec succ\xe8s!")}}),K=(0,r.useCallback)(async()=>{if(0===R.length)return void o.oR.error("Le panier est vide");try{let e={clientName:S||"Client",items:R.map(e=>({medicationId:e.medication.id,quantity:e.quantity,unitPrice:e.medication.price})),totalAmount:U};if(!(await fetch("/api/sales",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw Error("Erreur lors de la vente");o.oR.success("Vente effectu\xe9e avec succ\xe8s !"),q([]),E(""),await J(B),setTimeout(()=>{X()},500)}catch(e){console.error("Error completing sale:",e),o.oR.error("Erreur lors de la vente")}},[R,S,U,J,B,X]),Y=(0,r.useCallback)(()=>{M(!0)},[]),ee=(0,r.useCallback)(()=>{M(!1)},[]),es=(0,r.useCallback)(async e=>{try{let s=await fetch("/api/medications/barcode/".concat(e));if(s.ok){let e=await s.json();e?(V(e),ee(),o.oR.success("M\xe9dicament trouv\xe9: ".concat(e.name))):o.oR.error("Aucun m\xe9dicament trouv\xe9 avec ce code-barres")}else o.oR.error("Erreur lors de la recherche du m\xe9dicament")}catch(e){console.error("Error fetching medication by barcode:",e),o.oR.error("Erreur lors de la recherche du m\xe9dicament par code-barres.")}},[V,ee]),et=(0,r.useCallback)(()=>{},[]),ea=t.filter(s=>{if(!z&&s.quantity<=0)return!1;if(e&&e.length>0){let t=e.toLowerCase();return s.name.toLowerCase().includes(t)||s.barcode&&s.barcode.toLowerCase().includes(t)}return!0}).filter((e,s,t)=>t.findIndex(s=>s.name===e.name&&s.price===e.price&&s.quantity===e.quantity)===s).sort((e,s)=>{switch(P){case"name":return e.name.localeCompare(s.name);case"price":return e.price-s.price;case"stock":return s.quantity-e.quantity;default:return 0}});return(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(A.default,{userRole:"seller"}),(0,a.jsxs)("div",{className:"container mx-auto p-2 sm:p-4 lg:p-6 lg:pl-6",children:[(0,a.jsxs)("div",{className:"mb-4 sm:mb-6",children:[(0,a.jsx)("h1",{className:"text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900",children:"Interface de Vente"}),(0,a.jsx)("p",{className:"text-gray-600 mt-1 sm:mt-2 text-sm sm:text-base",children:"Recherchez et vendez des m\xe9dicaments"})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-3 lg:gap-6",children:[(0,a.jsxs)("div",{className:"lg:col-span-2 space-y-3 lg:space-y-4",children:[(0,a.jsxs)(l.Zp,{children:[(0,a.jsx)(l.aR,{className:"pb-3",children:(0,a.jsxs)(l.ZB,{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2",children:[(0,a.jsxs)("span",{className:"text-lg",children:["Recherche de M\xe9dicaments",ea.length>0&&(0,a.jsxs)("span",{className:"text-sm font-normal ml-2 bg-blue-100 text-blue-800 px-2 py-1 rounded-full",children:[ea.length," disponible",ea.length>1?"s":""]})]}),(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row gap-2",children:[(0,a.jsxs)(i.$,{onClick:Y,size:"sm",variant:"outline",className:"h-8 sm:h-9 cursor-pointer",children:[(0,a.jsx)(d.A,{className:"h-4 w-4 mr-1"}),"Scanner"]}),(0,a.jsxs)(i.$,{onClick:()=>$(!z),size:"sm",variant:z?"default":"outline",className:"h-8 sm:h-9 cursor-pointer",children:[z?"Masquer":"Afficher"," ruptures"]})]})]})}),(0,a.jsx)(l.Wu,{className:"space-y-3",children:(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row gap-2",children:[(0,a.jsxs)("div",{className:"relative flex-1",children:[(0,a.jsx)(n.p,{type:"text",placeholder:"Rechercher par nom ou code-barres...",value:e,onChange:e=>s(e.target.value),className:"w-full text-sm sm:text-base"}),(F||O)&&(0,a.jsx)(m.A,{className:"absolute right-3 top-2.5 h-4 w-4 animate-spin text-gray-400"})]}),(0,a.jsxs)("select",{value:P,onChange:e=>I(e.target.value),className:"px-3 py-2 border border-gray-300 rounded-md text-sm sm:text-base min-w-[120px]",children:[(0,a.jsx)("option",{value:"name",children:"Nom"}),(0,a.jsx)("option",{value:"price",children:"Prix"}),(0,a.jsx)("option",{value:"stock",children:"Stock"})]})]})})]}),(0,a.jsx)(l.Zp,{children:(0,a.jsxs)(l.Wu,{className:"p-0 relative",children:[(0,a.jsx)("div",{className:"text-xs text-white text-center py-1 bg-green-600 border-b",children:"âœ… MODIFICATIONS APPLIQU\xc9ES - Interface tableau optimis\xe9e"}),ea.length>5&&(0,a.jsx)("div",{className:"text-xs text-gray-500 text-center py-1 bg-blue-50 border-b",children:"\uD83D\uDCDC Faites d\xe9filer pour voir tous les m\xe9dicaments"}),(0,a.jsx)("div",{className:"overflow-x-auto max-h-[50vh] sm:max-h-[55vh] lg:max-h-[60vh] overflow-y-auto",children:(0,a.jsxs)(c.XI,{children:[(0,a.jsx)(c.A0,{className:"sticky top-0 bg-white z-10 shadow-sm",children:(0,a.jsxs)(c.Hj,{children:[(0,a.jsx)(c.nd,{className:"text-sm",children:"Nom"}),(0,a.jsx)(c.nd,{className:"text-sm",children:"Prix"}),(0,a.jsx)(c.nd,{className:"text-sm",children:"Stock"}),(0,a.jsx)(c.nd,{className:"text-sm",children:"Action"})]})}),(0,a.jsx)(c.BF,{children:0===ea.length?(0,a.jsx)(c.Hj,{children:(0,a.jsx)(c.nA,{colSpan:4,className:"text-center py-8 text-gray-500",children:F?"Chargement...":"Aucun m\xe9dicament trouv\xe9"})}):ea.map(e=>(0,a.jsxs)(c.Hj,{className:"hover:bg-gray-50",children:[(0,a.jsx)(c.nA,{className:"font-medium text-sm",children:e.name}),(0,a.jsx)(c.nA,{className:"text-green-600 font-semibold text-sm",children:(0,g.vv)(e.price)}),(0,a.jsx)(c.nA,{className:"text-sm",children:(0,a.jsx)("span",{className:e.quantity<=0?"text-red-600":"text-green-600",children:e.quantity})}),(0,a.jsx)(c.nA,{children:(0,a.jsxs)(i.$,{onClick:()=>V(e),disabled:e.quantity<=0,size:"sm",className:"text-xs px-2 py-1 cursor-pointer disabled:cursor-not-allowed",children:[(0,a.jsx)(x.A,{className:"h-3 w-3 mr-1"}),"+"]})})]},e.id))})]})})]})})]}),(0,a.jsx)("div",{className:"space-y-3 lg:space-y-4",children:(0,a.jsxs)(l.Zp,{children:[(0,a.jsx)(l.aR,{className:"pb-3",children:(0,a.jsxs)(l.ZB,{className:"flex items-center justify-between text-lg",children:[(0,a.jsxs)("span",{className:"flex items-center",children:[(0,a.jsx)(u.A,{className:"h-5 w-5 mr-2"}),"Panier (",R.length,")"]}),R.length>0&&(0,a.jsxs)(i.$,{onClick:Q,variant:"outline",size:"sm",className:"h-8 text-xs cursor-pointer",children:[(0,a.jsx)(h.A,{className:"h-3 w-3 mr-1"}),"Vider"]})]})}),(0,a.jsx)(l.Wu,{className:"space-y-3",children:0===R.length?(0,a.jsx)("p",{className:"text-gray-500 text-center py-4 text-sm",children:"Le panier est vide"}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"space-y-2 max-h-[35vh] sm:max-h-[40vh] lg:max-h-[45vh] overflow-y-auto border rounded-md p-2 bg-gray-50",children:R.map(e=>(0,a.jsxs)("div",{className:"border rounded-lg p-2 bg-gray-50",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-2",children:[(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsx)("h4",{className:"font-medium text-xs sm:text-sm leading-tight truncate",children:e.medication.name}),(0,a.jsxs)("p",{className:"text-xs text-gray-500",children:[(0,g.vv)(e.medication.price)," x ",e.quantity]})]}),(0,a.jsx)(i.$,{onClick:()=>G(e.medication.id),variant:"ghost",size:"sm",className:"h-6 w-6 p-0 ml-1 cursor-pointer",children:(0,a.jsx)(h.A,{className:"h-3 w-3"})})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,a.jsx)(i.$,{onClick:()=>W(e.medication.id,e.quantity-1),variant:"outline",size:"sm",className:"h-6 w-6 p-0 cursor-pointer",children:(0,a.jsx)(p.A,{className:"h-3 w-3"})}),(0,a.jsx)("span",{className:"font-medium text-sm min-w-[2rem] text-center",children:e.quantity}),(0,a.jsx)(i.$,{onClick:()=>W(e.medication.id,e.quantity+1),variant:"outline",size:"sm",className:"h-6 w-6 p-0 cursor-pointer disabled:cursor-not-allowed",disabled:e.quantity>=e.medication.quantity,children:(0,a.jsx)(x.A,{className:"h-3 w-3"})})]}),(0,a.jsx)("span",{className:"font-semibold text-green-600 text-sm",children:(0,g.vv)(e.medication.price*e.quantity)})]})]},e.medication.id))}),(0,a.jsxs)("div",{className:"border-t pt-3 space-y-3",children:[(0,a.jsxs)("div",{className:"flex justify-between text-lg font-bold",children:[(0,a.jsx)("span",{children:"Total:"}),(0,a.jsx)("span",{className:"text-green-600",children:(0,g.vv)(U)})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)(w.J,{htmlFor:"clientName",className:"text-sm",children:"Nom du client (optionnel)"}),(0,a.jsx)(n.p,{id:"clientName",type:"text",placeholder:"Nom du client...",value:S,onChange:e=>E(e.target.value),className:"text-sm"})]}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)(i.$,{onClick:K,className:"w-full text-sm cursor-pointer",children:[(0,a.jsx)(u.A,{className:"h-4 w-4 mr-2"}),"Finaliser la vente"]}),(0,a.jsxs)(i.$,{onClick:()=>{if(0===R.length)return void o.oR.error("Le panier est vide. Impossible de g\xe9n\xe9rer une facture.");Z(!0)},variant:"outline",className:"w-full text-sm cursor-pointer",children:[(0,a.jsx)(j.A,{className:"h-4 w-4 mr-2"}),"Aper\xe7u & Impression"]})]})]})]})})]})})]}),(0,a.jsx)(y.lG,{open:H,onOpenChange:Z,children:(0,a.jsxs)(y.Cf,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[(0,a.jsx)(y.c7,{children:(0,a.jsx)(y.L3,{children:"Aper\xe7u de la facture"})}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("div",{className:"border rounded-lg p-4 bg-white",children:(0,a.jsx)(C.A,{ref:D,cart:R,totalAmount:U,clientName:S})}),(0,a.jsxs)("div",{className:"flex justify-between items-center pt-4 border-t",children:[(0,a.jsx)(i.$,{variant:"outline",onClick:()=>Z(!1),className:"cursor-pointer",children:"Annuler"}),(0,a.jsxs)("div",{className:"flex space-x-3",children:[(0,a.jsxs)(i.$,{onClick:()=>{let e=window.open("","_blank");if(e&&D.current){let s=D.current.innerHTML||"";e.document.write("\n                        <html>\n                          <head>\n                            <title>Facture PAJO PHARMA</title>\n                            <style>\n                              body { font-family: Arial, sans-serif; margin: 20px; }\n                              .print-header { text-align: center; margin-bottom: 20px; }\n                              table { width: 100%; border-collapse: collapse; }\n                              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\n                              th { background-color: #f2f2f2; }\n                              .total { font-weight: bold; font-size: 18px; }\n                              @media print { \n                                body { margin: 0; }\n                                .no-print { display: none; }\n                              }\n                            </style>\n                          </head>\n                          <body>\n                            ".concat(s,"\n                          </body>\n                        </html>\n                      ")),e.document.close(),e.print(),e.close(),Z(!1),o.oR.success("Facture imprim\xe9e avec succ\xe8s!")}},variant:"outline",className:"cursor-pointer",children:[(0,a.jsx)(j.A,{className:"mr-2 h-4 w-4"}),"Imprimer directement"]}),(0,a.jsxs)(i.$,{onClick:X,className:"bg-blue-600 hover:bg-blue-700 cursor-pointer",children:[(0,a.jsx)(j.A,{className:"mr-2 h-4 w-4"}),"Enregistrer PDF"]})]})]})]})]})}),(0,a.jsx)(y.lG,{open:_,onOpenChange:M,children:(0,a.jsxs)(y.Cf,{className:"sm:max-w-md",children:[(0,a.jsx)(y.c7,{children:(0,a.jsx)(y.L3,{children:"Scanner un code-barres"})}),(0,a.jsx)(b.A,{onScanSuccess:es,onScanError:et})]})}),(0,a.jsx)("div",{style:{display:"none"},children:(0,a.jsx)(C.A,{ref:D,cart:R,totalAmount:U,clientName:S})})]})]})}}},e=>{var s=s=>e(e.s=s);e.O(0,[5604,9039,7471,8595,1071,9221,4079,7456,8965,8441,1684,7358],()=>s(2218)),_N_E=e.O()}]);