(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6072],{1634:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>C});var a=t(5155),n=t(2115),l=t(2523),r=t(285),i=t(5127),c=t(6695),d=t(6671),o=t(1154),m=t(7901),x=t(9103),h=t(7809),u=t(8309),p=t(2525),j=t(1304),f=t(2897),N=t(8855),g=t(6609),y=t(9434),v=t(4165),b=t(4790),w=t(5057),A=t(9368),k=t(162);function C(){let[e,s]=(0,n.useState)(""),[t,C]=(0,n.useState)([]),[q,S]=(0,n.useState)([]),[R,E]=(0,n.useState)(""),[P,z]=(0,n.useState)("name"),[F,$]=(0,n.useState)(!1),[T,D]=(0,n.useState)(!1),[L,M]=(0,n.useState)(!1),O=n.useRef(null),[Z,_]=(0,n.useState)(!1),[B,H]=(0,n.useState)(!1),[V,I]=(0,n.useState)(!1),J=(0,f.d)(e,300);(0,n.useEffect)(()=>{e!==J?M(!0):M(!1)},[e,J]),(0,n.useEffect)(()=>{(async()=>{try{D(!0);let e={inStock:!0,...J.length>0&&{search:J}},s=await (0,N.Pz)(e);C(s)}catch(e){console.error("Failed to fetch medications:",e),C([]),d.oR.error("Erreur lors de la recherche des m\xe9dicaments.")}finally{D(!1)}})()},[J]);let W=(0,n.useCallback)(e=>{S(s=>{let t=s.find(s=>s.medication.id===e.id);if(t)if(t.quantity<e.quantity)return s.map(s=>s.medication.id===e.id?{...s,quantity:s.quantity+1}:s);else return d.oR.warning("Stock insuffisant pour ".concat(e.name,".")),s;return e.quantity>0?[...s,{medication:e,quantity:1}]:(d.oR.warning("".concat(e.name," est en rupture de stock.")),s)})},[S,s,C]),G=(e,s)=>{S(t=>t.map(t=>{if(t.medication.id===e){let e=t.quantity+s;if(e>0&&e<=t.medication.quantity)return{...t,quantity:e};if(e<=0)return null;d.oR.warning("Stock insuffisant pour ".concat(t.medication.name,"."))}return t}).filter(Boolean))},X=e=>{S(s=>s.filter(s=>s.medication.id!==e))},K=q.reduce((e,s)=>e+s.medication.price*s.quantity,0),Q=(0,g.useReactToPrint)({contentRef:O,documentTitle:"Facture_".concat(Date.now()),onAfterPrint:()=>{I(!1),H(!0)}}),U=async()=>{if(0===q.length)return void d.oR.error("Le panier est vide. Impossible d'enregistrer la vente.");try{let e=await fetch("/api/sales",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({clientName:R||"Client Anonyme",totalAmount:K,amountPaid:K,changeDue:0,paymentMethod:"Esp\xe8ces",items:q.map(e=>({medicationId:e.medication.id,quantity:e.quantity,priceAtSale:e.medication.price}))})});if(e.ok){d.oR.success("Vente enregistr\xe9e avec succ\xe8s!"),S([]),E(""),H(!1);try{await Promise.allSettled([fetch("/api/daily-report",{cache:"no-store"}),fetch("/api/sales?today=true",{cache:"no-store"})])}catch(e){}}else{let s="HTTP ".concat(e.status);try{let t=await e.json();s=t.message||t.error||s}catch(e){}d.oR.error("Erreur lors de l'enregistrement de la vente: ".concat(s))}}catch(e){console.error("Failed to save sale:",e),d.oR.error("Erreur r\xe9seau lors de l'enregistrement de la vente.")}},Y=(0,n.useCallback)(async e=>{_(!1);try{let s=await fetch("/api/medications?search=".concat(e)),t=await s.json();t&&t.length>0?(W(t[0]),d.oR.success("M\xe9dicament ".concat(t[0].name," ajout\xe9 au panier."))):d.oR.error("M\xe9dicament non trouv\xe9 avec ce code-barres.")}catch(e){console.error("Error fetching medication by barcode:",e),d.oR.error("Erreur lors de la recherche du m\xe9dicament par code-barres.")}},[W]),ee=(0,n.useCallback)(()=>{},[]);return(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(k.default,{userRole:"admin"}),(0,a.jsxs)("div",{className:"p-2 sm:p-4 lg:p-8 lg:pl-8",children:[(0,a.jsx)("h1",{className:"text-xl sm:text-2xl lg:text-3xl font-bold mb-4 sm:mb-6 lg:mb-8",children:"Vente Rapide"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-4 sm:gap-6 lg:gap-8",children:[(0,a.jsxs)("div",{className:"lg:col-span-3",children:[(0,a.jsxs)(c.Zp,{className:"mb-4 sm:mb-6 lg:mb-8",children:[(0,a.jsx)(c.aR,{className:"pb-3 sm:pb-4",children:(0,a.jsx)(c.ZB,{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2",children:(0,a.jsxs)("span",{className:"text-lg sm:text-xl",children:["M\xe9dicaments en Stock",Array.isArray(t)&&t.filter(e=>F||e.quantity>0).length>0&&(0,a.jsxs)("span",{className:"text-sm font-normal ml-2 bg-blue-100 text-blue-800 px-2 py-1 rounded-full",children:[t.filter(e=>F||e.quantity>0).length," disponible",t.filter(e=>F||e.quantity>0).length>1?"s":""]})]})})}),(0,a.jsxs)(c.Wu,{children:[(0,a.jsxs)("div",{className:"space-y-3 sm:space-y-4 mb-4 sm:mb-6",children:[(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2",children:[(0,a.jsxs)("div",{className:"relative flex-grow",children:[(0,a.jsx)(l.p,{placeholder:"Rechercher un m\xe9dicament (nom ou code-barres)",value:e,onChange:e=>s(e.target.value),className:"flex-grow pr-10 h-12 text-base",onKeyDown:e=>{"Enter"===e.key&&e.preventDefault(),"Escape"===e.key&&s("")}}),(T||L)&&(0,a.jsx)("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2",children:(0,a.jsx)(o.A,{className:"h-4 w-4 animate-spin text-blue-500"})})]}),(0,a.jsxs)("div",{className:"flex space-x-2",children:[(0,a.jsx)(r.$,{onClick:()=>s(""),variant:"outline",title:"Effacer la recherche",className:"h-12 px-4 cursor-pointer",children:"Effacer"}),(0,a.jsx)(r.$,{onClick:()=>_(!0),variant:"outline",size:"icon",className:"h-12 w-12 cursor-pointer",children:(0,a.jsx)(m.A,{className:"h-5 w-5"})})]})]}),e&&(0,a.jsx)("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded",children:L?(0,a.jsxs)("span",{className:"flex items-center gap-2",children:[(0,a.jsx)(o.A,{className:"h-4 w-4 animate-spin"}),"Recherche en cours..."]}):T?(0,a.jsxs)("span",{className:"flex items-center gap-2",children:[(0,a.jsx)(o.A,{className:"h-4 w-4 animate-spin"}),"Chargement des r\xe9sultats..."]}):(0,a.jsxs)("span",{children:[t.length," r\xe9sultat",1!==t.length?"s":""," trouv\xe9",1!==t.length?"s":"",'pour "',e,'"']})}),(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row flex-wrap gap-3 sm:gap-4 items-start sm:items-center",children:[(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)(w.J,{htmlFor:"sort-select",className:"text-sm",children:"Trier par:"}),(0,a.jsxs)("select",{id:"sort-select",value:P,onChange:e=>z(e.target.value),className:"px-3 py-2 border rounded-md text-sm bg-white",children:[(0,a.jsx)("option",{value:"name",children:"Nom"}),(0,a.jsx)("option",{value:"price",children:"Prix"}),(0,a.jsx)("option",{value:"stock",children:"Stock"})]})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("input",{type:"checkbox",id:"show-out-of-stock",checked:F,onChange:e=>$(e.target.checked),className:"h-4 w-4"}),(0,a.jsx)(w.J,{htmlFor:"show-out-of-stock",className:"text-sm",children:"Afficher ruptures de stock"})]}),(0,a.jsx)(r.$,{variant:"outline",onClick:()=>window.location.reload(),className:"text-sm h-9",children:"Recharger"})]})]}),t.length>0?(0,a.jsxs)("div",{className:"border rounded-md overflow-hidden",children:[t.filter(e=>F||e.quantity>0).length>5&&(0,a.jsx)("div",{className:"text-xs text-gray-500 text-center py-1 bg-blue-50 border-b",children:"\uD83D\uDCDC Faites d\xe9filer pour voir tous les m\xe9dicaments"}),(0,a.jsx)("div",{className:"overflow-x-auto max-h-[50vh] sm:max-h-[55vh] lg:max-h-[60vh] overflow-y-auto",children:(0,a.jsxs)(i.XI,{children:[(0,a.jsx)(i.A0,{className:"sticky top-0 bg-white z-10 shadow-sm",children:(0,a.jsxs)(i.Hj,{children:[(0,a.jsx)(i.nd,{className:"text-sm",children:"Nom"}),(0,a.jsx)(i.nd,{className:"text-sm",children:"Prix"}),(0,a.jsx)(i.nd,{className:"text-sm",children:"Stock"}),(0,a.jsx)(i.nd,{className:"text-sm",children:"Action"})]})}),(0,a.jsx)(i.BF,{children:Array.isArray(t)?t.filter(e=>F||e.quantity>0).sort((e,s)=>"name"===P?e.name.localeCompare(s.name):"price"===P?e.price-s.price:"stock"===P?s.quantity-e.quantity:0).map(e=>(0,a.jsxs)(i.Hj,{className:"hover:bg-gray-50",children:[(0,a.jsx)(i.nA,{className:"font-medium text-sm",children:e.name}),(0,a.jsx)(i.nA,{className:"text-green-600 font-semibold text-sm",children:(0,y.vv)(e.price)}),(0,a.jsx)(i.nA,{className:"text-sm",children:(0,a.jsx)("span",{className:e.quantity<=0?"text-red-600":"text-green-600",children:e.quantity})}),(0,a.jsx)(i.nA,{children:(0,a.jsxs)(r.$,{onClick:()=>W(e),disabled:e.quantity<=0,size:"sm",className:"text-xs px-2 py-1 cursor-pointer disabled:cursor-not-allowed",children:[(0,a.jsx)(x.A,{className:"h-3 w-3 mr-1"}),"+"]})})]},e.id)):[]})]})})]}):(0,a.jsx)("div",{className:"text-center py-8 text-gray-500",children:e?(0,a.jsxs)("div",{children:[(0,a.jsxs)("p",{children:['Aucun m\xe9dicament trouv\xe9 pour "',e,'"']}),(0,a.jsx)("p",{className:"text-sm",children:"Essayez avec un autre terme de recherche"})]}):(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{children:"Aucun m\xe9dicament en stock trouv\xe9"}),(0,a.jsx)("p",{className:"text-sm",children:'V\xe9rifiez les stocks dans la section "Stock"'})]})})]})]}),(0,a.jsxs)(c.Zp,{className:"mb-4 lg:mb-0",children:[(0,a.jsx)(c.aR,{className:"pb-3",children:(0,a.jsxs)(c.ZB,{className:"flex items-center justify-between text-lg",children:["Panier",q.length>0&&(0,a.jsxs)("span",{className:"text-sm font-normal bg-blue-100 text-blue-800 px-3 py-1 rounded-full",children:[q.length," article",q.length>1?"s":""]})]})}),(0,a.jsx)(c.Wu,{className:"space-y-4",children:0===q.length?(0,a.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,a.jsx)(h.A,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,a.jsx)("p",{className:"font-medium",children:"Le panier est vide"}),(0,a.jsx)("p",{className:"text-sm",children:"Ajoutez des m\xe9dicaments pour commencer une vente"})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)(i.XI,{children:[(0,a.jsx)(i.A0,{children:(0,a.jsxs)(i.Hj,{children:[(0,a.jsx)(i.nd,{className:"text-sm",children:"M\xe9dicament"}),(0,a.jsx)(i.nd,{className:"text-sm",children:"Prix Unit."}),(0,a.jsx)(i.nd,{className:"text-sm",children:"Quantit\xe9"}),(0,a.jsx)(i.nd,{className:"text-sm text-right",children:"Sous-total"}),(0,a.jsx)(i.nd,{className:"text-sm text-right",children:"Actions"})]})}),(0,a.jsx)(i.BF,{children:q.map(e=>(0,a.jsxs)(i.Hj,{children:[(0,a.jsx)(i.nA,{className:"text-sm",children:e.medication.name}),(0,a.jsx)(i.nA,{className:"text-sm",children:(0,y.vv)(e.medication.price)}),(0,a.jsx)(i.nA,{children:(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)(r.$,{variant:"outline",size:"sm",className:"h-6 w-6 p-0 cursor-pointer",onClick:()=>G(e.medication.id,-1),children:(0,a.jsx)(u.A,{className:"h-3 w-3"})}),(0,a.jsx)("span",{className:"mx-1 text-sm font-medium min-w-[2rem] text-center",children:e.quantity}),(0,a.jsx)(r.$,{variant:"outline",size:"sm",className:"h-6 w-6 p-0 cursor-pointer",onClick:()=>G(e.medication.id,1),children:(0,a.jsx)(x.A,{className:"h-3 w-3"})})]})}),(0,a.jsx)(i.nA,{className:"text-right text-sm font-semibold text-green-600",children:(0,y.vv)(e.medication.price*e.quantity)}),(0,a.jsx)(i.nA,{className:"text-right",children:(0,a.jsx)(r.$,{variant:"destructive",size:"sm",className:"h-6 w-6 p-0 cursor-pointer",onClick:()=>X(e.medication.id),children:(0,a.jsx)(p.A,{className:"h-3 w-3"})})})]},e.medication.id))})]})}),(0,a.jsx)("div",{className:"border-t pt-4",children:(0,a.jsxs)("div",{className:"flex justify-end items-center text-xl font-bold mb-4",children:["Total: ",(0,y.vv)(K)]})})]})})]})]}),(0,a.jsxs)("div",{className:"lg:col-span-1",children:[(0,a.jsxs)(c.Zp,{className:"sticky top-4",children:[(0,a.jsx)(c.aR,{className:"pb-3",children:(0,a.jsx)(c.ZB,{className:"text-lg",children:"Finaliser la Vente"})}),(0,a.jsxs)(c.Wu,{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"bg-blue-50 p-4 rounded-lg",children:[(0,a.jsx)("h3",{className:"font-semibold mb-3 text-gray-900",children:"R\xe9sum\xe9"}),(0,a.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{className:"text-gray-600",children:"Articles:"}),(0,a.jsx)("span",{className:"font-medium",children:q.reduce((e,s)=>e+s.quantity,0)})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center border-t pt-2",children:[(0,a.jsx)("span",{className:"text-lg font-semibold",children:"Total:"}),(0,a.jsx)("span",{className:"text-2xl font-bold text-green-600",children:(0,y.vv)(K)})]})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)(w.J,{htmlFor:"client-name",className:"text-sm font-medium",children:"Nom du client (facultatif)"}),(0,a.jsx)(l.p,{id:"client-name",placeholder:"Nom du client",value:R,onChange:e=>E(e.target.value),className:"mt-1 h-12 text-base"})]}),(0,a.jsxs)("div",{className:"space-y-3 pt-4",children:[(0,a.jsxs)(r.$,{onClick:()=>{if(0===q.length)return void d.oR.error("Le panier est vide. Impossible de g\xe9n\xe9rer une facture.");I(!0)},className:"w-full h-12 text-base font-semibold bg-blue-600 hover:bg-blue-700 cursor-pointer",disabled:0===q.length,size:"lg",children:[(0,a.jsx)(j.A,{className:"mr-2 h-5 w-5"}),"Aper\xe7u Facture & Vente"]}),(0,a.jsx)(r.$,{onClick:U,className:"w-full h-12 text-base cursor-pointer",variant:"outline",disabled:0===q.length,size:"lg",children:"Vente Rapide"})]})]})]}),(0,a.jsxs)(c.Zp,{className:"mt-4",children:[(0,a.jsx)(c.aR,{children:(0,a.jsx)(c.ZB,{className:"text-lg",children:"Statistiques"})}),(0,a.jsx)(c.Wu,{children:(0,a.jsxs)("div",{className:"space-y-2 text-sm",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{children:"M\xe9dicaments disponibles:"}),(0,a.jsx)("span",{className:"font-semibold text-green-600",children:Array.isArray(t)?t.filter(e=>e.quantity>0).length:0})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{children:"Stock faible:"}),(0,a.jsx)("span",{className:"font-semibold text-orange-600",children:Array.isArray(t)?t.filter(e=>e.quantity>0&&e.quantity<=10).length:0})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("span",{children:"Ruptures de stock:"}),(0,a.jsx)("span",{className:"font-semibold text-red-600",children:Array.isArray(t)?t.filter(e=>0===e.quantity).length:0})]})]})})]})]})]}),(0,a.jsx)(v.lG,{open:Z,onOpenChange:_,children:(0,a.jsxs)(v.Cf,{children:[(0,a.jsx)(v.c7,{children:(0,a.jsx)(v.L3,{children:"Scanner un Code-barres"})}),(0,a.jsx)(b.A,{onScanSuccess:Y,onScanError:ee})]})}),(0,a.jsx)(v.lG,{open:V,onOpenChange:I,children:(0,a.jsxs)(v.Cf,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[(0,a.jsx)(v.c7,{children:(0,a.jsx)(v.L3,{children:"Aper\xe7u de la facture"})}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("div",{className:"border rounded-lg p-4 bg-white",children:(0,a.jsx)(A.A,{ref:O,cart:q,totalAmount:K,clientName:R})}),(0,a.jsxs)("div",{className:"flex justify-between items-center pt-4 border-t",children:[(0,a.jsx)(r.$,{variant:"outline",onClick:()=>I(!1),className:"cursor-pointer",children:"Annuler"}),(0,a.jsxs)("div",{className:"flex space-x-3",children:[(0,a.jsxs)(r.$,{onClick:()=>{let e=window.open("","_blank");if(e&&O.current){let s=O.current.innerHTML||"";e.document.write("\n                        <html>\n                          <head>\n                            <title>Facture PAJO PHARMA</title>\n                            <style>\n                              body { font-family: Arial, sans-serif; margin: 20px; }\n                              .print-header { text-align: center; margin-bottom: 20px; }\n                              table { width: 100%; border-collapse: collapse; }\n                              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\n                              th { background-color: #f2f2f2; }\n                              .total { font-weight: bold; font-size: 18px; }\n                              @media print { \n                                body { margin: 0; }\n                                .no-print { display: none; }\n                              }\n                            </style>\n                          </head>\n                          <body>\n                            ".concat(s,"\n                          </body>\n                        </html>\n                      ")),e.document.close(),e.print(),e.close(),I(!1),H(!0)}},variant:"outline",className:"cursor-pointer",children:[(0,a.jsx)(j.A,{className:"mr-2 h-4 w-4"}),"Imprimer directement"]}),(0,a.jsxs)(r.$,{onClick:Q,className:"bg-blue-600 hover:bg-blue-700 cursor-pointer",children:[(0,a.jsx)(j.A,{className:"mr-2 h-4 w-4"}),"Enregistrer PDF"]})]})]})]})]})}),(0,a.jsx)(v.lG,{open:B,onOpenChange:H,children:(0,a.jsxs)(v.Cf,{className:"sm:max-w-md",children:[(0,a.jsx)(v.c7,{children:(0,a.jsx)(v.L3,{children:"Confirmer la vente"})}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("p",{className:"text-sm text-gray-600",children:"La facture a \xe9t\xe9 imprim\xe9e/enregistr\xe9e. Voulez-vous maintenant enregistrer cette vente dans le syst\xe8me ?"}),(0,a.jsxs)("div",{className:"flex justify-end space-x-3",children:[(0,a.jsx)(r.$,{variant:"outline",onClick:()=>H(!1),className:"cursor-pointer",children:"Annuler"}),(0,a.jsx)(r.$,{onClick:U,className:"bg-green-600 hover:bg-green-700 cursor-pointer",children:"Confirmer la vente"})]})]})]})}),(0,a.jsx)("div",{style:{display:"none"},children:(0,a.jsx)(A.A,{ref:O,cart:q,totalAmount:K,clientName:R})})]})]})}},6662:(e,s,t)=>{Promise.resolve().then(t.bind(t,1634))}},e=>{var s=s=>e(e.s=s);e.O(0,[5604,9039,7471,8595,1071,9221,4079,7456,8965,8441,1684,7358],()=>s(6662)),_N_E=e.O()}]);